---
title: "Micro-MoB"
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Micro-MoB}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(MicroMoB)
```

In old MicroMoB $\Psi$ was TaR.
In old MicroMoB $W$ was SiG (but it seems to be a matrix in the old one).
In old MicroMoB $\kappa$ was NI.
In old MicroMoB $\beta$ was DiB.

## Design considerations

The way **Micro-MoB** should work means that single dispatch should be sufficient
to update the model.

### Human population strata `R/human.R`

In Spatial Dynamics we have:

\begin{equation}
P = J \cdot H
\end{equation}

In this software we assume a user provides `J`, `H` when making the human object
in `setup_human`. If working with complex strata, the helper function `strata_to_residency`
can generate a suitable `J` matrix.

There are $p$ patches and $n$ strata. In general, $n \geq p$ because there may be
multiple strata with the same patch residency (e.g. young, middle-aged, old). If
$n > p$ then the number of demographic strata summing over patches is $s = n/p$.

We will call $s$ demographic strata, and $n$ strata. If there are 2 demographic
strata and 3 patches, n = 6.

The dimensions are as follows:

  * $P_{p\times 1}$: vector of human populations at each patch (all strata)
  * $J_{p\times n}$: residency matrix mapping strata to patch
  * $H_{n\times 1}$: vector of human populations (strata)
  
### Human mobility time spent

The time spent matrix fulfills the following constraint:

\begin{equation}
\sum_j \Theta_{i,j} \leq 1
\end{equation}

The time spent matrix has dimension $\Theta_{n\times p}$.

The software uses `setup.timespent` to assign $\Theta$ to the model object. It
can either be a single matrix or a list of matrices if modeling fractions of a day.

### Ambient populations

### Time at risk `R/time_spent.R`

In Spatial dynamics we have:

$$
\int_{0}^1 \xi(s) ds=1
$$
$\xi$ is normalized to 1, so it is a probability density. It gives the probability
of the time of day a mosquito initiates a blood feeding attempt (including search),
_conditional_ on the mosquito attempting to blood feed that day.

In the software, if the smallest fraction of time modeled is a day, it is vaculously
equal to 1, because it says, if a mosquito attempts to blood feed today, then with
probability 1, they start the attempt today. Otherwise, `Xi` will be a vector
that sums to 1, giving the probability of each block.

The time at risk (TaR) matrix, $\Psi$ is then:

$$
\Psi(t) = \Theta(t) \xi(t)
$$

In the software, `compute_Psi.timespent` computes $\Psi^{T}$ and dispatches based
on a daily or sub-daily model of time spent. Because it is a scalar times `Theta`,
it has dimensions $\Psi_{n\times p}$.

### Human availability `R/time_spent.R`

Human availability is a vector-centric concept. It is something akin to giving
the expectation number of persons available to be bitten at each patch, but
the additional multiplication by $\xi$ means it is weighted by the probability 
of a mosquito to initiate the search at that time $t$. Also $w_{f,n\times 1}$
is a vector of search weights.

$$
W(t) = \Psi(t)^T \cdot w_f H
$$
The vector has dimension $W_{p\times 1}$.

The function `compute_wf.biteweight` computes `w_f`, the vector of
biting weights, used by `compute_W.timespent` computes `W`.

## Other blood hosts `R/other_hosts.R`

Other vertebrate mammals may provide bloodmeals for mosquitoes. There is a vector,
$B(t)_{p\times 1}$ giving the biting weight (expected number of other hosts weighted
by their search weight).

`compute_B.otherhosts` computes this vector.

### Blood feeding rates

### The human fraction

### The biting distribution matrix

The biting distribution matrix must obey the following constraint `colSums(diag(par$H) %*% par$beta) = 1`.

### Net infectiousness of humans $\kappa$

In a standard Ross-Macdonald model, the force of infection on mosquitoes is $acx$
where $x = X/H$ is prevalence of disease in humans, $a = fq$ is the human
feeding rate, and $c$ is the transmission efficiency. From this, we know $\kappa$
is the part referring to the net infectiousness of the human host population, 
the proportion of bites on humans which infect a mosquito.

```{r}
H <- 100
I <- 20
c <- 0.15
X <- I/H

kappa <- c * X
kappa
```

In Micro-MoB and RM-Spatial it's calculated like this:

$$
\kappa_{p\times 1} = \upsilon_{p\times 1} (\beta_{p\times n}^{\intercal} x_{n\times1}) + (1 - \upsilon_{p\times 1})x_{\delta_{p\times 1}}
$$
Here, $\upsilon_{p\times 1}$ is the resident fraction in each patch, $x_{\delta_{p\times 1}}$ is the net infectiousness of visitors, and
$\beta_{n\times p}$ is the biting distribution matrix.

In order to try to sync the models, lets examine how $\beta$ is made:

$$
\beta_{n\times p} = \mbox{diag}(w_{f})_{n\times n} \cdot \Psi_{n\times p} \cdot \mbox{diag}(1/W)_{p\times p}
$$

Where $W_{p\times 1} = \Psi^{\intercal}_{p\times n} \cdot w_{f}H_{n\times 1}$ is the available human population, $\Psi = \Theta \xi$ is the time at risk matrix,
and $w_{f}$ are biting weights.

To line up with the simple $\kappa$ from the RM model, let's assume there is only 1 patch, 1 strata, and the biting weight is $1$. We assume that
there are no visitors, such that $\upsilon = 1$.

```{r}
Theta <- matrix(1, nrow = 1, ncol = 1)
Psi <- Theta * 1
w_f <- 1
W <- t(Psi) %*% (w_f * H)

beta <- diag(w_f) %*% Psi %*% diag(1/W)

x <- c * X

kappa_new <- t(beta) %*% (x)
kappa_new
```

It looks like new $\kappa$ is off, in fact its off by precisely a factor of $1/H$, as I suspected:

```{r}
kappa_new * H
```

This is because $\beta$ simplifies to $1/H$. So the new computation of $\kappa$ has 
an extra term of $1/H$ that is extraneous:

$$
\beta = 1 \cdot (1) \cdot (1/H) \\
\kappa = (1/H) cx = (1/H)c(I/H)
$$


